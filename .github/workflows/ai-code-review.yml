name: AI Code Review

# =========================
# STEP 1. ì–¸ì œ ì‹¤í–‰í• ì§€ ì •ì˜
# =========================
on:
  pull_request:
    types: [opened, synchronize, closed]
    branches:
      - main
      - master
      - develop

# =========================
# STEP 2. ì‹¤í–‰í•  ì‘ì—… ì •ì˜
# =========================
jobs:
  review:
    runs-on: ubuntu-latest   # GitHubê°€ ì œê³µí•˜ëŠ” ë¦¬ëˆ…ìŠ¤ ì„œë²„

    steps:
      # ---------------------------------
      # STEP 3. ë ˆí¬ì§€í† ë¦¬ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      # ---------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        # â†‘ ì´ ì¤„ì€ "í˜„ì¬ ë ˆí¬ì˜ ì½”ë“œë¥¼
        #   GitHub Actions ì„œë²„ë¡œ ë³µì‚¬"
        #   í•˜ëŠ” ê³µì‹ ì•¡ì…˜

      # ---------------------------------
      # STEP 4. PR ë³€ê²½ ì½”ë“œ(diff) ê°€ì ¸ì˜¤ê¸°
      # ---------------------------------
      - name: Get PR diff
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ“¥ Fetching PR diff..."
          curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files \
            > diff.json

      # ---------------------------------
      # STEP 5. diffì—ì„œ patchë§Œ ì¶”ì¶œ
      # ---------------------------------
      - name: Extract diff patches
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ§¹ Extracting patch content..."
          jq -r '.[] | .patch' diff.json > review_input.txt

          echo "===== REVIEW INPUT ====="
          cat review_input.txt

      # ---------------------------------
      # STEP 6. AI ì½”ë“œ ë¦¬ë·° (ì§€ê¸ˆì€ MOCK)
      # ---------------------------------
      - name: AI Code Review (mock)
        if: github.event.action != 'closed'
        run: |
          echo "ğŸ¤– AI code review started..."
          echo "ì´ ë¶€ë¶„ì—ì„œ ì‹¤ì œë¡œëŠ” AI APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤." > review_result.txt
          echo "ë³€ê²½ëœ ì½”ë“œì— ëŒ€í•œ ë¦¬ë·° ê²°ê³¼ ì˜ˆì‹œì…ë‹ˆë‹¤." >> review_result.txt

      # ---------------------------------
      # STEP 7. PRì— ë¦¬ë·° ê²°ê³¼ ì½”ë©˜íŠ¸
      # ---------------------------------
      - name: Comment on PR
        if: github.event.action != 'closed'
        run: |
          REVIEW=$(cat review_result.txt)

          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            -d "{
              \"body\": \"ğŸ¤– AI ì½”ë“œ ë¦¬ë·° ê²°ê³¼\n\n$REVIEW\"
            }"

      # ---------------------------------
      # STEP 8. merge ì™„ë£Œ ì‹œ ì•Œë¦¼ (ì˜ˆì‹œ)
      # ---------------------------------
      - name: Notify merge completed
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        run: |
          echo "âœ… PR merged into ${{ github.base_ref }}"
