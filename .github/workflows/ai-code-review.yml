name: AI Code Review

# =========================
# STEP 1. Ïñ∏Ï†ú Ïã§ÌñâÌï†ÏßÄ Ï†ïÏùò
# =========================
on:
  pull_request:
    types: [opened, synchronize, closed]
    branches:
      - main
      - master
      - develop

# =========================
# STEP 2. Ïã§ÌñâÌï† ÏûëÏóÖ Ï†ïÏùò
# =========================
jobs:
  review:
    runs-on: ubuntu-latest   # GitHubÍ∞Ä Ï†úÍ≥µÌïòÎäî Î¶¨ÎàÖÏä§ ÏÑúÎ≤Ñ

    steps:
      # ---------------------------------
      # STEP 3. Î†àÌè¨ÏßÄÌÜ†Î¶¨ ÏΩîÎìú Í∞ÄÏ†∏Ïò§Í∏∞
      # ---------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        # ‚Üë Ïù¥ Ï§ÑÏùÄ "ÌòÑÏû¨ Î†àÌè¨Ïùò ÏΩîÎìúÎ•º
        #   GitHub Actions ÏÑúÎ≤ÑÎ°ú Î≥µÏÇ¨"
        #   ÌïòÎäî Í≥µÏãù Ïï°ÏÖò

      # ---------------------------------
      # STEP 4. PR Î≥ÄÍ≤Ω ÏΩîÎìú(diff) Í∞ÄÏ†∏Ïò§Í∏∞
      # ---------------------------------
      - name: Get PR diff
        if: github.event_name == 'pull_request'
        run: |
          echo "üì• Fetching PR diff..."
          curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files \
            > diff.json

      # ---------------------------------
      # STEP 5. diffÏóêÏÑú patchÎßå Ï∂îÏ∂ú
      # ---------------------------------
      - name: Extract diff patches
        if: github.event_name == 'pull_request'
        run: |
          echo "üßπ Extracting patch content..."
          jq -r '.[] | .patch' diff.json > review_input.txt

          echo "===== REVIEW INPUT ====="
          cat review_input.txt

      # ---------------------------------
      # STEP 6. AI ÏΩîÎìú Î¶¨Î∑∞
      # ---------------------------------
      - name: AI Code Review
        if: github.event.action != 'closed'
        id: ai
        run: |
          REVIEW=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d '{
              "model": "gpt-4o-mini",
              "messages": [
                {
                  "role": "system",
                  "content": "You are a senior developer performing a code review."
                },
                {
                  "role": "user",
                  "content": "Please review the following git diff and give constructive feedback:\n\n'"$(sed 's/"/\\"/g' diff.txt)"'"
                }
              ]
            }' | jq -r '.choices[0].message.content')

          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      # ---------------------------------
      # STEP 7. PRÏóê Î¶¨Î∑∞ Í≤∞Í≥º ÏΩîÎ©òÌä∏
      # ---------------------------------
      - name: Comment on PR
        if: github.event.action != 'closed'
        run: |
          REVIEW=$(cat review_result.txt)

          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            -d "{
              \"body\": \"ü§ñ AI ÏΩîÎìú Î¶¨Î∑∞ Í≤∞Í≥º\n\n$REVIEW\"
              ${{ steps.ai.outputs.review }}
            }"

      # ---------------------------------
      # STEP 8. merge ÏôÑÎ£å Ïãú ÏïåÎ¶º (ÏòàÏãú)
      # ---------------------------------
      - name: Notify merge completed
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        run: |
          echo "‚úÖ PR merged into ${{ github.base_ref }}"
